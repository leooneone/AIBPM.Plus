import{_ as M}from"./preload-helper.101896b7.js";import{d as ae,a6 as V,r as Y,O as ce,o as pe,H as J,w as ue,S as D,e as U,f as F,p as fe,v as he,g as _,z as x,u as P,m as O,t as ge,F as me,B as ve,x as W,L as ye,ab as Ne,ac as _e,I as Ee,l as Ce}from"./vue.df334614.js";import{_ as xe}from"./_plugin-vue_export-helper.c27b6911.js";const Ie="/assets/coordinate.18df25ec.svg",w=E=>Array.isArray(E)?E.length===0:!0;class R{static idGenerator(){let t=new Date-new Date("2020-08-01");t+=Math.ceil(Math.random()*1e3);const s="0123456789ABCDEFGHIGKLMNOPQRSTUVWXYZabcdefghigklmnopqrstuvwxyz",n=s.split(""),o=s.length,p=[];do{let a=t%o;t=(t-a)/o,p.push(n[a])}while(t);return p.join("")}static isConditionNode(t){return t&&t.type==="condition"}static isCopyNode(t){return t&&t.type==="copy"}static isStartNode(t){return t&&t.type==="start"}static isEndNode(t){return t&&t.type==="end"}static isApproverNode(t){return t&&t.type==="approver"}static getPreviousNode(t,s){if(s.nodeId===t)return s;if(s.childNode){let n=this.getPreviousNode(t,s.childNode);if(n)return n}if(s.conditionNodes)for(let n of s.conditionNodes){let o=this.getPreviousNode(t,n);if(o)return o}}static deleteNode(t,s,n=!0){let o=this.getPreviousNode(t.prevId,s);if(n&&o.type==="empty"){if(this.isConditionNode(t)){const a=o.conditionNodes.length===2,g=a?o:t;this.deleteNode(g,s,a)}else w(o.conditionNodes)&&this.deleteNode(o,s),this.deleteNode(t,s,!1);return}let p=(a,g)=>{a.childNode=g.childNode,w(a.conditionNodes)&&(a.conditionNodes=g.conditionNodes),a.childNode&&(a.childNode.prevId=a.nodeId),a.conditionNodes&&a.conditionNodes.forEach(y=>y.prevId=a.nodeId)};if(this.isConditionNode(t)){let a=o.conditionNodes,g=a.findIndex(y=>y.nodeId===t.nodeId);if(a.length>2)a.splice(g,1);else{let y=a[+!g];if(delete o.conditionNodes,o.childNode){let v=y;for(;v.childNode;)v=v.childNode;v.childNode=o.childNode,v.childNode.prevId=v.nodeId}p(o,y),o.childNode&&o.childNode.type==="empty"&&this.deleteNode(o.childNode,o)}a.forEach((y,v)=>y.properties.priority=v);return}p(o,t)}static addApprovalNode(t,s,n=void 0){let o=t.childNode;n=n||this.createNode("approver",t.nodeId),t.childNode=n,o&&(n.childNode=o,o.prevId=n.nodeId);let p=t.conditionNodes;Array.isArray(p)&&!s&&p.length&&(n.conditionNodes=p.map(a=>(a.prevId=n.nodeId,a)),delete t.conditionNodes),o&&o.type==="empty"&&n.type!=="empty"&&o.conditionNodes.length===0&&this.deleteNode(o,t)}static addEmptyNode(t){let s=this.createNode("empty",t.nodeId);return this.addApprovalNode(t,!0,s),s}static addCopyNode(t,s){this.addApprovalNode(t,s,this.createNode("copy",t.nodeId))}static appendConditionNode(t){const s=t.conditionNodes;let n=this.createNode("condition",t.nodeId),o=s.findIndex(p=>p.properties.isDefault);n.properties.priority=s.length,o>-1?(s.splice(-1,0,n),n.properties.priority=s.length-2,s[s.length-1].properties.priority=s.length-1):s.push(n),this.setDefaultCondition(n,t)}static appendBranch(t,s,n){console.log(t);let o=t;if(Array.isArray(t.conditionNodes)&&t.conditionNodes.length)if(s)o=this.addEmptyNode(o,!0);else{let a=this.addEmptyNode(o,!0);a.conditionNodes=o.conditionNodes,a.conditionNodes.forEach(g=>{g.prevId=a.nodeId})}let p=[this.createNode("condition",o.nodeId),this.createNode("condition",o.nodeId)].map((a,g)=>(a.properties.title+=g+1,a.properties.priority=g,a));n&&(p[0].childNode=o.childNode,o.childNode=void 0),o.conditionNodes=p}static appendBranch1(t,s){console.log(t);let n=t;if(Array.isArray(t.conditionNodes)&&t.conditionNodes.length)if(s)n=this.addEmptyNode(n,!0);else{let p=this.addEmptyNode(n,!0);p.conditionNodes=n.conditionNodes,p.conditionNodes.forEach(a=>{a.prevId=p.nodeId})}let o=[this.createNode("condition",n.nodeId),this.createNode("condition",n.nodeId)].map((p,a)=>(p.properties.title+=a+1,p.properties.priority=a,p));n.conditionNodes=o}static addNode(t,s){t[s.id]=s}static removeNode(t,s,n){var o=[];return t[s]&&(delete t[s],n.forEach(p=>{(p.fromId===s||p.toId===s)&&o.push(p.id)})),o}static addLine(t,s){t.push(s)}static removeLine(t,s,n){var o=t.findIndex(p=>p.id===s);t.splice(o,1),n[s]&&delete n[s]}static changeLine(t,s,n,o){this.removeLine(t,s,o),this.addLine(t,n)}static setDefaultCondition(t,s){const n="其他情况进入此流程",o=this.getPreviousNode(t.prevId,s).conditionNodes,p=e=>e.properties&&(e.properties.initiator||!w(e.properties.conditions)),a=e=>{e.properties.isDefault=!1,e.content===n&&(e.content="请设置条件")},g=e=>{e.properties.isDefault=!0,e.content=n};let y=0;o.slice(0,-1).forEach(e=>{p(e)&&y++,a(e)});const v=o[o.length-1];y>0&&!p(v)?g(v):a(v)}static checkNode(t,s){let n=!0;const o=t.approve;this.isConditionNode(t)&&!t.isDefault&&!t.initiator&&w(t.conditions)&&(n=!1);const p=["myself","optional","director","supervisor","form","title"];if(this.isApproverNode(t)){if(!p.includes(o.assigneeType)&&w(o.participants))return{valid:!1,msg:"参与人不能为空"};n=!1}return n}static checkAllNode(t){let s=!0;const n=(o,p,a)=>{!this.checkNode(o,a)&&p(),o.children&&n(o.children,p,a),w(o.conditionNodes)||o.conditionNodes.forEach(g=>n(g,p,o))};return n(t,()=>s=!1),s}}const L=E=>(Ne("data-v-01bc3660"),E=E(),_e(),E),be={class:"editMainContainer"},Se={style:{position:"absolute",top:"41px",right:"0px","z-index":"20","font-size":"12px !important",width:"640px","background-color":"white"}},we={key:0,class:"editLegendHeader"},Le=["src"],Ae=W(" 缩略图 "),De={class:"legendItem"},Pe=L(()=>_("div",{style:{"font-size":"22px"}},"🦉🦉🦉🦉🦉🦉🦉🦉",-1)),Oe=L(()=>_("div",null,"点击图形中节点/元素后",-1)),Re=L(()=>_("div",null,"如果当前设置为审批面板，则弹出审批设置面板",-1)),Te=L(()=>_("div",null,"如果当前设置为格式面板，则显示图形格式调整面板",-1)),Me=L(()=>_("div",null,"格式面板主要用于调整图形外观尺寸，颜色等，与流程设置无关。",-1)),Ve=L(()=>_("div",null,"如果需要调整样式建议使用工作流组件和网关栏下的图形组件,其他栏组件均为可替换图片。",-1)),Ue={class:"dialog-footer"},ke=W("知道了"),Ge=ae({name:"index",props:{conf:{type:Object,default:E=>{}},fields:{type:Array,default:[]},enableEditing:{type:Boolean,default:!0}},setup(E,{expose:t}){const s=E,n=V(()=>M(()=>import("./index.62d4f8dc.js"),["assets/index.62d4f8dc.js","assets/_plugin-vue_export-helper.c27b6911.js","assets/vue.df334614.js"])),o=V(()=>M(()=>import("./index.f5a9c9a2.js"),["assets/index.f5a9c9a2.js","assets/_plugin-vue_export-helper.c27b6911.js","assets/vue.df334614.js"])),p=V(()=>M(()=>import("./index.7892f204.js"),["assets/index.7892f204.js","assets/Permission.90a9a010.js","assets/vue.df334614.js","assets/_plugin-vue_export-helper.c27b6911.js","assets/Permission.8385cb28.css","assets/Operation.06714c7c.js","assets/Participant.5fcaadee.js","assets/index.a7cafc43.js","assets/user-select.fdd46137.js","assets/User.905b1cf5.js","assets/http-client.28a8ff7a.js","assets/index.de963593.js","assets/index.390778f0.js","assets/index.4621962e.js","assets/storage.6b2e7cd0.js","assets/org-menu.vue_vue_type_script_setup_true_lang.6d7eb461.js","assets/Org.791a1909.js","assets/tree.d5b28a07.js","assets/index.6c5a2d2c.js","assets/index.7cba2d6b.js","assets/index.f4a20413.js","assets/_Uint8Array.2a02cf9e.js","assets/index.e64efb6f.js","assets/_initCloneObject.115dee92.js","assets/focus-trap.ccecd842.js","assets/user-select.9baf66be.css","assets/org-select.vue_vue_type_script_setup_true_lang.1cbb9c1d.js","assets/role-select.vue_vue_type_script_setup_true_lang.c64fbe36.js","assets/Role.d52d88a4.js","assets/index.c0eb9a2b.css","assets/Participant.50caa650.css","assets/Condition.20a743ea.js","assets/Condition.d25ad008.css","assets/Circulate.f1f7e9a6.js"])),a=V(()=>M(()=>import("./index.77d120a1.js"),["assets/index.77d120a1.js","assets/_plugin-vue_export-helper.c27b6911.js","assets/vue.df334614.js","assets/index.73fd2e39.css"])),{proxy:g}=ye(),y=Y(),v=Y(),e=ce({isShowApproval:!0,enableEditing:!0,isErrorShow:!1,validResults:[],startActivityId:0,nodes:{},lines:[],curNode:{},curCellType:"",isPropPanel:!0,graph:null,saveCurrentTopo:!1,cellProperty:!1,importFile:!1,cellData:{},curCellId:{}});Ee("titleChange",i=>{var r=e.graph.getSelectionCells();e.graph.cellLabelChanged(r[0],i)});const q=()=>{e.graph.addListener(mxEvent.CELLS_ADDED,(r,d)=>{const c=d.properties.cells[0];e.graph.isPart(c)||(c.vertex?z(c):c.edge&&(z(c,"condition"),R.addLine(e.lines,{id:c.id,fromId:c.source.id,toId:c.target.id})))});var i=e.graph.cellLabelChanged;e.graph.cellLabelChanged=function(r,d,c){e.nodes[r.id].title!==d&&(e.nodes[r.id].title=d),i.apply(this,arguments)},e.graph.addListener(mxEvent.CONNECT_CELL,(r,d)=>{let c=d.properties.edge;d.properties.previous.id!==d.properties.terminal.id&&R.changeLine(e.lines,c.id,{id:c.id,fromId:c.source.id,toId:c.target.id},e.nodes)}),e.graph.addListener(mxEvent.CELLS_REMOVED,(r,d)=>{J(()=>{d.properties.cells.forEach(h=>{h.vertex?h.isGroup||ee(R.removeNode(e.nodes,h.id,e.lines)):h.edge&&R.removeLine(e.lines,h.id,e.nodes)})})})},Q=()=>{let i=0,r=0,d=[],c={},h={};const l=(u,f)=>{d.push({msg:u,group:f})};e.lines.forEach(u=>{c.hasOwnProperty(u.fromId)||(c[u.fromId]=[]),h.hasOwnProperty(u.toId)||(h[u.toId]=[]),c[u.fromId].push(u),h[u.toId].push(u)});for(let u in e.nodes){let f=e.nodes[u];f.type!=="condition"&&(f.type==="start"&&(e.startActivityId=f.id),f.type==="start"?i++:f.type==="end"&&r++,!["copy","end","inclusiveGw","exclusiveGw","parallelGw"].includes(f.type)&&f.permission&&f.permission.length===0&&l("请配置节点表单数据权限",f.title),["approve","deal"].includes(f.type)&&f.approve.hasOwnProperty("participants")&&(["myself","optional","director","supervisor","form","title"].includes(f.approve.assigneeType)||f.approve.participants.user.length===0&&f.approve.participants.role.length===0&&f.approve.participants.org.length===0&&l("请配置节点审批人员",f.title)),["start"].includes(f.type)||(!h[f.id]||h[f.id].length===0)&&l("节点需要入向连接",f.title),f.type==="end"?c[f.id]&&c[f.id].length>0&&l("结束节点应只存在入向连接",f.title):(!c[f.id]||c[f.id].length===0)&&l("节点需要出向连接",f.title))}(i==0||i>1)&&l("流程必须包含开始节点且唯一"),(r==0||r>1)&&l("流程必须包含结束节点且唯一");let m={};if(e.startActivityId>0){let u=!1;const f=(C,I)=>{var b=e.nodes[C],T=JSON.parse(JSON.stringify(b));if(I&&(T=e.nodes[I]),m[C]&&I){console.log("return");return}if(m[C]=!0,b.type==="parallelGw"||(T==null?void 0:T.type)==="parallelGw"){u=!0;return}else if(c[C]){let B=c[C],X=[];B.forEach(A=>{var N=e.nodes[A.id];console.log("nodeLine",N);var S=-1;if(N.condition?N.condition.isDefault?(S=0,X.push(A)):!N.condition.filters||N.condition.filters.length===0?S=-1:S=1:S=-1,B.length>1?S===-1&&(N.title===""&&(N.title="条件_"+N.id,$(N.id,N.title)),l("节点存在多条出向连线，请点击连线["+N.title+"]配置条件",b.title)):S===1&&l("节点仅一条出向连线，请点击连线["+N.title+"]取消条件配置",b.title),e.nodes[A.toId].type!=="end")f(A.toId,A.id);else{u=!0,console.log("return111");return}}),B.length>1&&(X.length===0?l("节点未设置默认条件，存在无法到达后续节点风险",b.title):X.length>1&&l("节点默认条件只允许1个",b.title))}};f(e.startActivityId),u||l("流程路线不完整")}return e.validResults=d,e.validResults.length>0&&(e.isErrorShow=!0),console.log("checkResults",d),d},Z=()=>new Promise((i,r)=>{Q().length===0?i({nodes:e.nodes,lines:e.lines,startActivityId:e.startActivityId,chartData:H()}):r({msg:"流程校验错误",target:"flowDesign"})}),j=()=>{var i;e.curNode!==void 0?(i=v.value)==null||i.open():g.$modal.msgWarning("请先选中单个节点再点编辑")},ee=i=>{var r=[];i.forEach(d=>{var c=K(d);c&&r.push(c)}),e.graph.removeCells(r)},z=(i,r)=>{if(i!==void 0){var d=i.id,c=e.graph.getCellStyle(i),h=r||mxUtils.getValue(c,"type","");if(h===""&&(h=""),h!==""){e.curCellType=h;let l={title:h+"_"+d,id:d,type:h,approve:{},condition:{},permission:[]};l.type==="start"?l.title="开始":l.type==="end"?l.title="结束":l.type==="deal"?l.title="人工_"+l.id:l.type==="approve"?l.title="审批_"+l.id:l.type==="parallelGw"?l.title="并行_"+l.id:l.type==="exclusiveGw"?l.title="排他_"+l.id:l.type==="condition"&&(l.title=""),R.addNode(e.nodes,l),$(l.id,l.title),k(d)}else g.$modal.msgWarning("添加了一个非流程节点图形")}},$=(i,r)=>{const d=K(i);d!==null&&e.graph.cellLabelChanged(d,r)},k=i=>{e.nodes[i]&&(e.curNode=e.nodes[i],e.isShowApproval&&j())},te=(i,r)=>{e.curNode=e.nodes[i]},oe=()=>{e.editorUiInit.actions.get("outline").funct(),e.editorUiInit.refresh()},ie=(i,r)=>{const d=document.createElement("a");d.setAttribute("href","data:application/xml;charset=utf-8,"+encodeURIComponent(r)),d.setAttribute("download",i),d.style.display="none",document.body.appendChild(d),d.click(),document.body.removeChild(d)},H=()=>{const i=e.editorUiInit.editor.getGraphXml();return new XMLSerializer().serializeToString(i)},se=({name:i="topology"}={})=>{ie(`${i}.xml`,H()),e.saveCurrentTopo=!1},ne=i=>{const{cell:r}=e.cellData;var d=mxUtils.createXmlDocument(),c=d.createElement("object");Object.keys(i).forEach(h=>{c.setAttribute(h,i[h])}),e.editorUiInit.editor.graph.getModel().setValue(r,c),e.cellProperty=!1,e.cellData={}},le=i=>{e.graph.diagramXml=i,e.graph.getModel().beginUpdate();try{const d=mxUtils.parseXml(i).documentElement,c=new mxCodec(d.ownerDocument);e.graph.getModel().clear(),c.decode(d,e.graph.getModel())}catch(r){console.log("err",r)}finally{e.graph.getModel().endUpdate()}re()},re=()=>{Object.values(e.graph.getModel().cells).forEach(i=>{i.vertex&&i.data&&(i.data=JSON.parse(i.data))})},K=i=>{var r=e.graph.getModel(),d=r.getCell(i);return d},G=i=>{e.graph&&i&&i.length>10&&le(i)},de=i=>{i.ctrlKey&&(i.keyCode===83&&(e.saveCurrentTopo=!0,i.preventDefault()),i.keyCode==77&&i.preventDefault())};return pe(()=>{{const i=EditorUi.prototype.init;EditorUi.prototype.getCellsForShapePicker=function(d){var c=mxUtils.bind(this,function(h,l,m,u){return this.editor.graph.createVertex(null,null,u||"",0,0,l||120,m||60,h,!1)});return[c("shape=bpmShape;type=parallelGw;verticalLabelPosition=bottom;strokeColor=#0082cf;fillColor=#a6cce5",50,50),c("shape=bpmShape;type=exclusiveGw;verticalLabelPosition=bottom;strokeColor=#0082cf;fillColor=#a6cce5",50,50)]},EditorUi.prototype.init=function(){i.apply(this,arguments),this.actions.get("export").setEnabled(!1),this.actions.addAction("editData",function(){j()},null,null,"Cmd+M")},mxResources.loadDefaultBundle=!1;const r=mxResources.getDefaultBundle(RESOURCE_BASE,mxLanguage)||mxResources.getSpecialBundle(RESOURCE_BASE,mxLanguage);mxUtils.getAll([r,"/resources/default.xml"],d=>{mxResources.parse(d[0].getText());const c={};c[Graph.prototype.defaultThemeName]=d[1].getDocumentElement(),e.editorUiInit=new EditorUi(new Editor(urlParams.chrome=="0",c),y.value),e.graph=e.editorUiInit.editor.graph,mxEdgeHandler.prototype.isConnectableCell=()=>!1,mxGraphHandler.prototype.guidesEnabled=!0,e.graph.setDisconnectOnMove(!1),e.graph.setAllowDanglingEdges(!1),mxGraph.prototype.isCellMovable=h=>!h.edge,e.graph.setMultigraph(!1),e.graph.setAllowLoops(!1),mxGraph.prototype.edgeLabelsMovable=!1,q(),e.graph.addMouseListener({currentState:null,previousStyle:null,mouseDown:(h,l)=>{if(l.state){if(l.state.cell.edge){k(l.state.cell.id);return}}else{e.curNode=void 0;return}const m=l.state.cell;let u=!1;if(k(m.id),m.style!==void 0&&(u=m.style.includes("normalType")),u)e.graph.fireEvent(new MxEventObject(MxEvent.NORMAL_TYPE_CLICKED,"cell",l));else return},mouseMove:(h,l)=>{e.graphX=Math.ceil(l.graphX),e.graphY=l.graphY},mouseUp:(h,l)=>{if(e.cellData={},l.sourceState!=null){var m=l.sourceState.cell;if(m){m.vertex?e.isNode=!0:e.isNode=!1;var u=m.getStyle()?m.getStyle():null;if(e.isNode||u&&(e.edgeStyle=u),u){var f=u.split(";"),C={};f.forEach(I=>{C[I.split("=")[0]]=I.split("=")[1]}),e.cellStyle=C,te(m.id,e.cellStyle)}}else g.$modal.msgError("请选择节点或者连线")}}}),J(()=>{document.getElementsByClassName("geDiagramContainer")[0].style="inset: 41px 240px 0px 220px; touch-action: none; cursor: default; overflow: hidden;",document.getElementsByClassName("geSidebarContainer")[0].style="left: 0px; top: 41px; width: 220px; bottom: 0px;",G(s.conf.chartData)})},d=>{g.$modal.msgError("当前浏览器不支持")})}}),ue(()=>s.conf,i=>{typeof i=="object"&&i.chartData!==void 0&&(e.lines=i.lines,e.nodes=i.nodes,G(i.chartData))},{immediate:!0}),t({getSetting:Z}),(i,r)=>{const d=D("el-switch"),c=D("el-tooltip"),h=D("el-alert"),l=D("el-button"),m=D("el-dialog");return U(),F("div",be,[fe(_("div",Se,[x(P(p),{ref_key:"propPanelRef",ref:v,node:e.curNode,fields:s.fields},null,8,["node","fields"])],512),[[he,e.isPropPanel]]),s.enableEditing?(U(),F("div",we,[_("div",{onClick:oe,class:"legendItem"},[_("img",{src:P(Ie),width:"10",alt:""},null,8,Le),Ae]),_("div",De,[x(c,{effect:"light"},{content:O(()=>[Pe,Oe,Re,Te,Me,Ve]),default:O(()=>[x(d,{modelValue:e.isShowApproval,"onUpdate:modelValue":r[0]||(r[0]=u=>e.isShowApproval=u),"inline-prompt":"","inactive-color":"rgb(0, 130, 207)","active-text":"审批面板","inactive-text":"格式面板"},null,8,["modelValue"])]),_:1})])])):ge("",!0),_("div",{class:"graphEditorContainer",ref_key:"editorContainerRef",ref:y,onKeydown:de},null,544),x(P(o),{isVisible:e.cellProperty,detailData:e.cellData,onOnDialogClose:r[1]||(r[1]=()=>{e.cellProperty=!1,e.cellData={}}),onOnDialogConfirm:ne},null,8,["isVisible","detailData"]),x(m,{modelValue:e.isErrorShow,"onUpdate:modelValue":r[3]||(r[3]=u=>e.isErrorShow=u),title:"流程设计器验证"},{footer:O(()=>[_("span",Ue,[x(l,{onClick:r[2]||(r[2]=u=>e.isErrorShow=!1)},{default:O(()=>[ke]),_:1})])]),default:O(()=>[(U(!0),F(me,null,ve(e.validResults,u=>(U(),Ce(h,{type:u.type||"error","show-icon":"",title:"【"+(u.group||"全局")+"】"+u.msg,style:{"margin-bottom":"10px"},closable:!1,"close-text":"【"+u.group+"】"},null,8,["type","title","close-text"]))),256))]),_:1},8,["modelValue"]),x(P(n),{isVisible:e.saveCurrentTopo,onOnDialogClose:r[4]||(r[4]=u=>e.saveCurrentTopo=!1),onOnDialogConfirm:se},null,8,["isVisible"]),x(P(a),{isVisible:e.importFile,onOnDialogClose:r[5]||(r[5]=u=>e.importFile=!1),onOnDialogConfirm:G},null,8,["isVisible"])])}}});const ze=xe(Ge,[["__scopeId","data-v-01bc3660"]]);export{ze as default};
