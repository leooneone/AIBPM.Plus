import D from"./index.afc935e7.js";import L from"./index.f5a9c9a2.js";import P from"./index.c996eb1a.js";import A from"./index.77d120a1.js";import{S as g,e as b,f as _,p as T,v as O,g as m,z as v,x as S,y as w,m as I,t as M,F as k,B as U,l as R}from"./vue.df334614.js";import{_ as B}from"./_plugin-vue_export-helper.c27b6911.js";import"./Permission.90a9a010.js";import"./Operation.06714c7c.js";import"./Participant.fd6627bd.js";import"./index.e0ad165c.js";import"./user-select.0622e36c.js";import"./User.4679a863.js";import"./http-client.ff22776c.js";import"./index.de963593.js";import"./index.390778f0.js";import"./index.4621962e.js";import"./storage.08e609be.js";import"./js.cookie.cf83ad76.js";import"./org-menu.vue_vue_type_script_setup_true_lang.2abc46e4.js";import"./Org.95a10495.js";import"./tree.d5b28a07.js";import"./index.6c5a2d2c.js";import"./index.7cba2d6b.js";import"./index.f4a20413.js";import"./_Uint8Array.2a02cf9e.js";import"./index.e64efb6f.js";import"./_initCloneObject.115dee92.js";import"./focus-trap.ccecd842.js";import"./org-select.vue_vue_type_script_setup_true_lang.c26e97f7.js";import"./role-select.vue_vue_type_script_setup_true_lang.d0b8f7bd.js";import"./Role.14cde0b3.js";import"./Condition.acab08a3.js";import"./Circulate.f172b24a.js";const C=l=>Array.isArray(l)?l.length===0:!0;class x{static idGenerator(){let e=new Date-new Date("2020-08-01");e+=Math.ceil(Math.random()*1e3);const o="0123456789ABCDEFGHIGKLMNOPQRSTUVWXYZabcdefghigklmnopqrstuvwxyz",s=o.split(""),t=o.length,i=[];do{let r=e%t;e=(e-r)/t,i.push(s[r])}while(e);return i.join("")}static isConditionNode(e){return e&&e.type==="condition"}static isCopyNode(e){return e&&e.type==="copy"}static isStartNode(e){return e&&e.type==="start"}static isEndNode(e){return e&&e.type==="end"}static isApproverNode(e){return e&&e.type==="approver"}static getPreviousNode(e,o){if(o.nodeId===e)return o;if(o.childNode){let s=this.getPreviousNode(e,o.childNode);if(s)return s}if(o.conditionNodes)for(let s of o.conditionNodes){let t=this.getPreviousNode(e,s);if(t)return t}}static deleteNode(e,o,s=!0){let t=this.getPreviousNode(e.prevId,o);if(s&&t.type==="empty"){if(this.isConditionNode(e)){const r=t.conditionNodes.length===2,d=r?t:e;this.deleteNode(d,o,r)}else C(t.conditionNodes)&&this.deleteNode(t,o),this.deleteNode(e,o,!1);return}let i=(r,d)=>{r.childNode=d.childNode,C(r.conditionNodes)&&(r.conditionNodes=d.conditionNodes),r.childNode&&(r.childNode.prevId=r.nodeId),r.conditionNodes&&r.conditionNodes.forEach(n=>n.prevId=r.nodeId)};if(this.isConditionNode(e)){let r=t.conditionNodes,d=r.findIndex(n=>n.nodeId===e.nodeId);if(r.length>2)r.splice(d,1);else{let n=r[+!d];if(delete t.conditionNodes,t.childNode){let a=n;for(;a.childNode;)a=a.childNode;a.childNode=t.childNode,a.childNode.prevId=a.nodeId}i(t,n),t.childNode&&t.childNode.type==="empty"&&this.deleteNode(t.childNode,t)}r.forEach((n,a)=>n.properties.priority=a);return}i(t,e)}static addApprovalNode(e,o,s=void 0){let t=e.childNode;s=s||this.createNode("approver",e.nodeId),e.childNode=s,t&&(s.childNode=t,t.prevId=s.nodeId);let i=e.conditionNodes;Array.isArray(i)&&!o&&i.length&&(s.conditionNodes=i.map(r=>(r.prevId=s.nodeId,r)),delete e.conditionNodes),t&&t.type==="empty"&&s.type!=="empty"&&t.conditionNodes.length===0&&this.deleteNode(t,e)}static addEmptyNode(e){let o=this.createNode("empty",e.nodeId);return this.addApprovalNode(e,!0,o),o}static addCopyNode(e,o){this.addApprovalNode(e,o,this.createNode("copy",e.nodeId))}static appendConditionNode(e){const o=e.conditionNodes;let s=this.createNode("condition",e.nodeId),t=o.findIndex(i=>i.properties.isDefault);s.properties.priority=o.length,t>-1?(o.splice(-1,0,s),s.properties.priority=o.length-2,o[o.length-1].properties.priority=o.length-1):o.push(s),this.setDefaultCondition(s,e)}static appendBranch(e,o,s){console.log(e);let t=e;if(Array.isArray(e.conditionNodes)&&e.conditionNodes.length)if(o)t=this.addEmptyNode(t,!0);else{let r=this.addEmptyNode(t,!0);r.conditionNodes=t.conditionNodes,r.conditionNodes.forEach(d=>{d.prevId=r.nodeId})}let i=[this.createNode("condition",t.nodeId),this.createNode("condition",t.nodeId)].map((r,d)=>(r.properties.title+=d+1,r.properties.priority=d,r));s&&(i[0].childNode=t.childNode,t.childNode=void 0),t.conditionNodes=i}static appendBranch1(e,o){console.log(e);let s=e;if(Array.isArray(e.conditionNodes)&&e.conditionNodes.length)if(o)s=this.addEmptyNode(s,!0);else{let i=this.addEmptyNode(s,!0);i.conditionNodes=s.conditionNodes,i.conditionNodes.forEach(r=>{r.prevId=i.nodeId})}let t=[this.createNode("condition",s.nodeId),this.createNode("condition",s.nodeId)].map((i,r)=>(i.properties.title+=r+1,i.properties.priority=r,i));s.conditionNodes=t}static addNode(e,o){e[o.id]=o}static removeNode(e,o,s){var t=[];return e[o]&&(delete e[o],s.forEach(i=>{(i.fromId===o||i.toId===o)&&t.push(i.id)})),t}static addLine(e,o){e.push(o)}static removeLine(e,o,s){var t=e.findIndex(i=>i.id===o);e.splice(t,1)}static changeLine(e,o,s,t){this.removeLine(e,o,t),this.addLine(e,s)}static setDefaultCondition(e,o){const s="其他情况进入此流程",t=this.getPreviousNode(e.prevId,o).conditionNodes,i=p=>p.properties&&(p.properties.initiator||!C(p.properties.conditions)),r=p=>{p.properties.isDefault=!1,p.content===s&&(p.content="请设置条件")},d=p=>{p.properties.isDefault=!0,p.content=s};let n=0;t.slice(0,-1).forEach(p=>{i(p)&&n++,r(p)});const a=t[t.length-1];n>0&&!i(a)?d(a):r(a)}static checkNode(e,o){let s=!0;const t=e.approve;this.isConditionNode(e)&&!e.isDefault&&!e.initiator&&C(e.conditions)&&(s=!1);const i=["myself","optional","director","supervisor","form","title"];if(this.isApproverNode(e)){if(!i.includes(t.assigneeType)&&C(t.participants))return{valid:!1,msg:"参与人不能为空"};s=!1}return s}static checkAllNode(e){let o=!0;const s=(t,i,r)=>{!this.checkNode(t,r)&&i(),t.children&&s(t.children,i,r),C(t.conditionNodes)||t.conditionNodes.forEach(d=>s(d,i,t))};return s(e,()=>o=!1),o}}const V={name:"flow",components:{NodeProp:P,SaveTopology:D,EditCellProperty:L,ImportFile:A},props:{conf:Object,fields:Array||[],enableEditing:{type:Boolean,default:!0}},data(){return{workflow:{},isErrorShow:!1,validResults:[],startActivityId:0,cellType:"",nodes:{},lines:[],curNode:{},workflowTypes:[{label:"开始",value:"start"},{label:"结束",value:"end"},{label:"条件",value:"condition"},{label:"传阅",value:"circulate"},{label:"审批",value:"approver"}],curCellType:"",isPropPanel:!0,graph:null,topoVal:"",saveCurrentTopo:!1,cellProperty:!1,importFile:!1,cellData:{},curCellId:{}}},computed:{},provide(){return{titleChange:this.textValueChange}},methods:{show(){},textValueChange(l){var e=this.graph.getSelectionCells();console.log(l,"节点文本新内容",this.graph),this.graph.cellLabelChanged(e[0],l)},addEventHandler(){var e=this;this.graph.addListener(mxEvent.CELLS_ADDED,(o,s)=>{const t=s.properties.cells[0];this.graph.isPart(t)||(t.vertex?e.addCell(t):t.edge&&(e.addCell(t,"condition"),this.$message.info("添加了一条线，起点："+t.source.id+"，终点："+t.target.id),x.addLine(this.lines,{id:t.id,fromId:t.source.id,toId:t.target.id})))});var e=this,l=this.graph.cellLabelChanged;this.graph.cellLabelChanged=function(o,s,t){e.nodes[o.id].title!==s&&(e.nodes[o.id].title=s),l.apply(this,arguments)};var e=this;this.graph.addListener(mxEvent.CONNECT_CELL,(o,s)=>{let t=s.properties.edge;s.properties.previous.id!==s.properties.terminal.id&&x.changeLine(this.lines,t.id,{id:t.id,fromId:t.source.id,toId:t.target.id},this.nodes)});var e=this;this.graph.addListener(mxEvent.CELLS_REMOVED,(o,s)=>{this.$nextTick(()=>{s.properties.cells.forEach(i=>{i.vertex?i.isGroup?this.$message.info(`移除了组${i.id}`):(this.$message.info(`移除节点${i.id}`),e.removeCells(x.removeNode(this.nodes,i.id,this.lines))):i.edge&&(this.$message.info("移除了线"),x.removeLine(this.lines,i.id,this.nodes))})})})},blink(l,e,o,s){let t=this.nodes[l.id].storkeColor,i=t;if(t===s&&(i=o),this.graph.setCellStyles(mxConstants.STYLE_STROKECOLOR,s,[l]),!(e<=0)){var r=this;setTimeout(function(){r.blink(l,--e,o,i)},300)}},validChart(){let l=0,e=0,o=[],s={},t={};const i=(d,n)=>{o.push({msg:d,group:n})};this.lines.forEach(d=>{s.hasOwnProperty(d.fromId)||(s[d.fromId]=[]),t.hasOwnProperty(d.toId)||(t[d.toId]=[]),s[d.fromId].push(d),t[d.toId].push(d)});for(let d in this.nodes){let n=this.nodes[d];n.type!=="condition"&&(n.type==="start"&&(this.startActivityId=n.id),n.type==="start"?l++:n.type==="end"&&e++,!["copy","end","inclusiveGw","exclusiveGw","parallelGw"].includes(n.type)&&n.permission&&n.permission.length===0&&i("请配置节点表单数据权限",n.title),["approve","deal"].includes(n.type)&&n.approve.hasOwnProperty("participants")&&(["myself","optional","director","supervisor","form","title"].includes(n.approve.assigneeType)||n.approve.participants.user.length===0&&n.approve.participants.role.length===0&&n.approve.participants.org.length===0&&i("请配置节点审批人员",n.title)),["start"].includes(n.type)||(!t[n.id]||t[n.id].length===0)&&i("节点需要入向连接",n.title),n.type==="end"?s[n.id]&&s[n.id].length>0&&i("结束节点应只存在入向连接",n.title):(!s[n.id]||s[n.id].length===0)&&i("节点需要出向连接",n.title))}(l==0||l>1)&&i("流程必须包含开始节点且唯一"),(e==0||e>1)&&i("流程必须包含结束节点且唯一");let r={};if(this.startActivityId>0){let d=!1;const n=(a,p)=>{var h=this.nodes[a],f=JSON.parse(JSON.stringify(h));if(p&&(f=this.nodes[p]),r[a]&&p){console.log("return");return}if(r[a]=!0,h.type==="parallelGw"||(f==null?void 0:f.type)==="parallelGw"){d=!0;return}else if(s[a]){let c=s[a],y=[];c.forEach(E=>{var u=this.nodes[E.id];console.log("nodeLine",u);var N=-1;if(u.condition?u.condition.isDefault?(N=0,y.push(E)):!u.condition.filters||u.condition.filters.length===0?N=-1:N=1:N=-1,c.length>1?N===-1&&(u.title===""&&(u.title="条件_"+u.id,this.setCellLabel(u.id,u.title)),i("节点存在多条出向连线，请点击连线["+u.title+"]配置条件",h.title)):N===1&&i("节点仅一条出向连线，请点击连线["+u.title+"]取消条件配置",h.title),this.nodes[E.toId].type!=="end")n(E.toId,E.id);else{d=!0,console.log("return111");return}}),c.length>1&&(y.length===0?i("节点未设置默认条件，存在无法到达后续节点风险",h.title):y.length>1&&i("节点默认条件只允许1个",h.title))}};n(this.startActivityId),d||i("流程路线不完整")}return this.validResults=o,this.validResults.length>0&&(this.isErrorShow=!0),console.log("checkResults",o),o},getSetting(){return new Promise((l,e)=>{this.validChart().length===0?l({nodes:this.nodes,lines:this.lines,startActivityId:this.startActivityId,chartData:this.getChartXml()}):e({msg:"流程校验错误",target:"flowDesign"})})},openPropPanel(){this.curNode!==void 0?this.$refs.propPanelRef.open():this.$message.warning("请先选中单个节点再点编辑")},removeCells(l){var e=[];l.forEach(o=>{var s=this.getCell(o);s&&e.push(s)}),this.graph.removeCells(e)},addCell(l,e){if(l!==void 0){var o=l.id,s=this.graph.getCellStyle(l),t=e||mxUtils.getValue(s,"type","");if(t===""&&(t=""),t!==""){this.curCellType=t;let i={title:t+"_"+o,id:o,type:t,approve:{},condition:{},permission:[]};i.type==="start"?i.title="开始":i.type==="end"?i.title="结束":i.type==="deal"?i.title="人工_"+i.id:i.type==="approve"?i.title="审批_"+i.id:i.type==="parallelGw"?i.title="并行_"+i.id:i.type==="exclusiveGw"?i.title="排他_"+i.id:i.type==="condition"&&(i.title=""),x.addNode(this.nodes,i),this.setCellLabel(i.id,i.title),this.activeCell(o),this.$message.info("添加了一个流程节点")}else this.$message.warning("添加了一个非流程节点图形")}},setCellLabel(l,e){const o=this.getCell(l);o!==null&&this.graph.cellLabelChanged(o,e)},activeCell(l){this.nodes[l]&&(this.curNode=this.nodes[l])},updateCellStyle(l,e){this.curNode=this.nodes[l]},getCellType(l){},togglePropPanel(){this.isPropPanel=!this.isPropPanel},onProp(l){},handleThumbnail(){this.editorUiInit.actions.get("outline").funct(),this.editorUiInit.refresh()},downloadFile(l,e){const o=document.createElement("a");o.setAttribute("href","data:application/xml;charset=utf-8,"+encodeURIComponent(e)),o.setAttribute("download",l),o.style.display="none",document.body.appendChild(o),o.click(),document.body.removeChild(o)},getChartXml(){const l=this.editorUiInit.editor.getGraphXml();return new XMLSerializer().serializeToString(l)},exportTopology({name:l="topology"}={}){this.downloadFile(`${l}.xml`,this.getChartXml()),this.saveCurrentTopo=!1},saveActiveCell(l){const{cell:e}=this.cellData;var o=mxUtils.createXmlDocument(),s=o.createElement("object");Object.keys(l).forEach(t=>{s.setAttribute(t,l[t])}),this.editorUiInit.editor.graph.getModel().setValue(e,s),this.cellProperty=!1,this.cellData={}},openEditCellDialog(){this.openPropPanel()},importModelXML(l){this.graph.diagramXml=l,this.graph.getModel().beginUpdate();try{const o=mxUtils.parseXml(l).documentElement,s=new mxCodec(o.ownerDocument);this.graph.getModel().clear(),s.decode(o,this.graph.getModel())}catch(e){console.log("err",e)}finally{this.graph.getModel().endUpdate()}this._restoreModel()},_restoreModel(){Object.values(this.graph.getModel().cells).forEach(l=>{l.vertex&&l.data&&(l.data=JSON.parse(l.data))})},getCell(l){var e=this.graph.getModel(),o=e.getCell(l);return o},parseXmlFile(l){this.importModelXML(l)},bindEvents(l){l.ctrlKey&&(l.keyCode===83&&(this.saveCurrentTopo=!0,l.preventDefault()),l.keyCode==77&&l.preventDefault())}},mounted(){const l=this,e=this.$refs.editorContainer,o=EditorUi.prototype.init,s=this.$message;EditorUi.prototype.getCellsForShapePicker=function(i){var r=mxUtils.bind(this,function(d,n,a,p){return this.editor.graph.createVertex(null,null,p||"",0,0,n||120,a||60,d,!1)});return[r("shape=bpmShape;type=parallelGw;verticalLabelPosition=bottom;strokeColor=#0082cf;fillColor=#a6cce5",50,50,"并行网关"),r("shape=bpmShape;type=exclusiveGw;verticalLabelPosition=bottom;strokeColor=#0082cf;fillColor=#a6cce5",50,50,"排他网关")]},EditorUi.prototype.init=function(){o.apply(this,arguments),this.actions.get("export").setEnabled(!1),this.actions.addAction("editData",function(){l.openEditCellDialog()},null,null,"Cmd+M")},mxResources.loadDefaultBundle=!1;const t=mxResources.getDefaultBundle(RESOURCE_BASE,mxLanguage)||mxResources.getSpecialBundle(RESOURCE_BASE,mxLanguage);mxUtils.getAll([t,"/resources/default.xml"],i=>{mxResources.parse(i[0].getText());const r={};r[Graph.prototype.defaultThemeName]=i[1].getDocumentElement(),this.editorUiInit=new EditorUi(new Editor(urlParams.chrome=="0",r),e),this.$emit("onInitEditGraph",this.editorUiInit),this.graph=this.editorUiInit.editor.graph,mxEdgeHandler.prototype.isConnectableCell=()=>!1,mxGraphHandler.prototype.guidesEnabled=!0,this.graph.setDisconnectOnMove(!1),this.graph.setAllowDanglingEdges(!1),mxGraph.prototype.isCellMovable=n=>!n.edge,this.graph.setMultigraph(!1),this.graph.setAllowLoops(!1),mxGraph.prototype.edgeLabelsMovable=!1,this.addEventHandler();var d=this;this.graph.addMouseListener({currentState:null,previousStyle:null,mouseDown:(n,a)=>{if(a.state){if(a.state.cell.edge){console.log("点击了连线");return}}else{console.log("点击了画布"),this.curNode=void 0;return}const p=a.state.cell;let h=!1;if(this.activeCell(p.id),p.style!==void 0&&(h=p.style.includes("normalType")),h)this.graph.fireEvent(new MxEventObject(MxEvent.NORMAL_TYPE_CLICKED,"cell",a));else return},mouseMove:(n,a)=>{this.graphX=Math.ceil(a.graphX),this.graphY=a.graphY},mouseUp:(n,a)=>{if(d.cellData={},a.sourceState!=null){var p=a.sourceState.cell;if(p){p.vertex?this.isNode=!0:this.isNode=!1;var h=p.getStyle()?p.getStyle():null;if(this.isNode||h&&(this.edgeStyle=h),d.getCellType(p),h){var f=h.split(";"),c={};f.forEach(y=>{c[y.split("=")[0]]=y.split("=")[1]}),this.cellStyle=c,this.updateCellStyle(p.id,this.cellStyle)}}else this.$message.error("请选择节点或者连线")}}}),typeof this.conf=="object"&&this.conf.chartData!==void 0&&(console.log("load line",this.conf),this.lines=this.conf.lines,this.nodes=this.conf.nodes,this.parseXmlFile(this.conf.chartData));var d=this;this.$nextTick(()=>{document.getElementsByClassName("geDiagramContainer")[0].style="inset: 41px 240px 0px 220px; touch-action: none; cursor: default; overflow: hidden;",document.getElementsByClassName("geSidebarContainer")[0].style="left: 0px; top: 41px; width: 220px; bottom: 0px;"})},i=>{s.error("当前浏览器不支持")})}};const F={class:"editMainContainer"},G={style:{position:"absolute",top:"41px",right:"0px","z-index":"20","font-size":"12px !important",width:"640px","background-color":"white"}},X={key:0,class:"editLegendHeader"},j=["src"],z=["src"],H=S("审批节点配置"),K={class:"dialog-footer"},Y=S("知道了");function J(l,e,o,s,t,i){const r=g("NodeProp"),d=g("el-button"),n=g("EditCellProperty"),a=g("el-alert"),p=g("el-dialog"),h=g("SaveTopology"),f=g("ImportFile");return b(),_("div",F,[T(m("div",G,[v(r,{ref:"propPanelRef",node:t.curNode,fields:o.fields},null,8,["node","fields"])],512),[[O,t.isPropPanel]]),o.enableEditing?(b(),_("div",X,[m("div",{onClick:e[0]||(e[0]=(...c)=>i.handleThumbnail&&i.handleThumbnail(...c)),class:"legendItem"},[m("img",{src:l.coordinateSvg,width:"10",alt:""},null,8,j),S(" 缩略图"+w(Object.keys(t.nodes).length)+"|"+w(t.lines.length),1)]),m("div",{class:"legendItem",onClick:e[1]||(e[1]=(...c)=>i.openEditCellDialog&&i.openEditCellDialog(...c))},[m("img",{src:l.editSvg,width:"10",alt:""},null,8,z),v(d,{plain:"",type:"primary",icon:"ele-Edit"},{default:I(()=>[H]),_:1})])])):M("",!0),m("div",{class:"graphEditorContainer",ref:"editorContainer",onKeydown:e[2]||(e[2]=(...c)=>i.bindEvents&&i.bindEvents(...c))},null,544),v(n,{isVisible:t.cellProperty,detailData:t.cellData,onOnDialogClose:e[3]||(e[3]=()=>{t.cellProperty=!1,t.cellData={}}),onOnDialogConfirm:i.saveActiveCell},null,8,["isVisible","detailData","onOnDialogConfirm"]),v(p,{modelValue:t.isErrorShow,"onUpdate:modelValue":e[5]||(e[5]=c=>t.isErrorShow=c),title:"流程设计器验证"},{footer:I(()=>[m("span",K,[v(d,{onClick:e[4]||(e[4]=c=>t.isErrorShow=!1)},{default:I(()=>[Y]),_:1})])]),default:I(()=>[(b(!0),_(k,null,U(t.validResults,c=>(b(),R(a,{type:c.type||"error","show-icon":"",title:"【"+(c.group||"全局")+"】"+c.msg,style:{"margin-bottom":"10px"},closable:!1,"close-text":"【"+c.group+"】"},null,8,["type","title","close-text"]))),256))]),_:1},8,["modelValue"]),v(h,{isVisible:t.saveCurrentTopo,onOnDialogClose:e[6]||(e[6]=c=>t.saveCurrentTopo=!1),onOnDialogConfirm:i.exportTopology},null,8,["isVisible","onOnDialogConfirm"]),v(f,{isVisible:t.importFile,onOnDialogClose:e[7]||(e[7]=c=>t.importFile=!1),onOnDialogConfirm:i.parseXmlFile},null,8,["isVisible","onOnDialogConfirm"])])}const De=B(V,[["render",J],["__scopeId","data-v-5150c5db"]]);export{De as default};
