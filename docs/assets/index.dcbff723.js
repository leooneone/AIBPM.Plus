import{_ as R}from"./preload-helper.101896b7.js";import{d as ae,a6 as V,r as Y,O as ce,o as pe,H as J,w as ue,S as D,e as U,f as F,p as fe,v as he,g as N,z as x,u as P,m as O,t as ge,F as me,B as ve,x as W,L as ye,ab as Ne,ac as _e,I as Ee,l as Ce}from"./vue.72f2672d.js";import{_ as xe}from"./_plugin-vue_export-helper.c27b6911.js";const Ie="/assets/coordinate.18df25ec.svg",w=E=>Array.isArray(E)?E.length===0:!0;class T{static idGenerator(){let t=new Date-new Date("2020-08-01");t+=Math.ceil(Math.random()*1e3);const s="0123456789ABCDEFGHIGKLMNOPQRSTUVWXYZabcdefghigklmnopqrstuvwxyz",n=s.split(""),o=s.length,p=[];do{let d=t%o;t=(t-d)/o,p.push(n[d])}while(t);return p.join("")}static isConditionNode(t){return t&&t.type==="condition"}static isCopyNode(t){return t&&t.type==="copy"}static isStartNode(t){return t&&t.type==="start"}static isEndNode(t){return t&&t.type==="end"}static isApproverNode(t){return t&&t.type==="approver"}static getPreviousNode(t,s){if(s.nodeId===t)return s;if(s.childNode){let n=this.getPreviousNode(t,s.childNode);if(n)return n}if(s.conditionNodes)for(let n of s.conditionNodes){let o=this.getPreviousNode(t,n);if(o)return o}}static deleteNode(t,s,n=!0){let o=this.getPreviousNode(t.prevId,s);if(n&&o.type==="empty"){if(this.isConditionNode(t)){const d=o.conditionNodes.length===2,g=d?o:t;this.deleteNode(g,s,d)}else w(o.conditionNodes)&&this.deleteNode(o,s),this.deleteNode(t,s,!1);return}let p=(d,g)=>{d.childNode=g.childNode,w(d.conditionNodes)&&(d.conditionNodes=g.conditionNodes),d.childNode&&(d.childNode.prevId=d.nodeId),d.conditionNodes&&d.conditionNodes.forEach(y=>y.prevId=d.nodeId)};if(this.isConditionNode(t)){let d=o.conditionNodes,g=d.findIndex(y=>y.nodeId===t.nodeId);if(d.length>2)d.splice(g,1);else{let y=d[+!g];if(delete o.conditionNodes,o.childNode){let v=y;for(;v.childNode;)v=v.childNode;v.childNode=o.childNode,v.childNode.prevId=v.nodeId}p(o,y),o.childNode&&o.childNode.type==="empty"&&this.deleteNode(o.childNode,o)}d.forEach((y,v)=>y.properties.priority=v);return}p(o,t)}static addApprovalNode(t,s,n=void 0){let o=t.childNode;n=n||this.createNode("approver",t.nodeId),t.childNode=n,o&&(n.childNode=o,o.prevId=n.nodeId);let p=t.conditionNodes;Array.isArray(p)&&!s&&p.length&&(n.conditionNodes=p.map(d=>(d.prevId=n.nodeId,d)),delete t.conditionNodes),o&&o.type==="empty"&&n.type!=="empty"&&o.conditionNodes.length===0&&this.deleteNode(o,t)}static addEmptyNode(t){let s=this.createNode("empty",t.nodeId);return this.addApprovalNode(t,!0,s),s}static addCopyNode(t,s){this.addApprovalNode(t,s,this.createNode("copy",t.nodeId))}static appendConditionNode(t){const s=t.conditionNodes;let n=this.createNode("condition",t.nodeId),o=s.findIndex(p=>p.properties.isDefault);n.properties.priority=s.length,o>-1?(s.splice(-1,0,n),n.properties.priority=s.length-2,s[s.length-1].properties.priority=s.length-1):s.push(n),this.setDefaultCondition(n,t)}static appendBranch(t,s,n){console.log(t);let o=t;if(Array.isArray(t.conditionNodes)&&t.conditionNodes.length)if(s)o=this.addEmptyNode(o,!0);else{let d=this.addEmptyNode(o,!0);d.conditionNodes=o.conditionNodes,d.conditionNodes.forEach(g=>{g.prevId=d.nodeId})}let p=[this.createNode("condition",o.nodeId),this.createNode("condition",o.nodeId)].map((d,g)=>(d.properties.title+=g+1,d.properties.priority=g,d));n&&(p[0].childNode=o.childNode,o.childNode=void 0),o.conditionNodes=p}static appendBranch1(t,s){console.log(t);let n=t;if(Array.isArray(t.conditionNodes)&&t.conditionNodes.length)if(s)n=this.addEmptyNode(n,!0);else{let p=this.addEmptyNode(n,!0);p.conditionNodes=n.conditionNodes,p.conditionNodes.forEach(d=>{d.prevId=p.nodeId})}let o=[this.createNode("condition",n.nodeId),this.createNode("condition",n.nodeId)].map((p,d)=>(p.properties.title+=d+1,p.properties.priority=d,p));n.conditionNodes=o}static addNode(t,s){t[s.id]=s}static removeNode(t,s,n){var o=[];return t[s]&&(delete t[s],n.forEach(p=>{(p.fromId===s||p.toId===s)&&o.push(p.id)})),o}static addLine(t,s){t.push(s)}static removeLine(t,s,n){var o=t.findIndex(p=>p.id===s);t.splice(o,1),n[s]&&delete n[s]}static changeLine(t,s,n,o){this.removeLine(t,s,o),this.addLine(t,n)}static setDefaultCondition(t,s){const n="其他情况进入此流程",o=this.getPreviousNode(t.prevId,s).conditionNodes,p=e=>e.properties&&(e.properties.initiator||!w(e.properties.conditions)),d=e=>{e.properties.isDefault=!1,e.content===n&&(e.content="请设置条件")},g=e=>{e.properties.isDefault=!0,e.content=n};let y=0;o.slice(0,-1).forEach(e=>{p(e)&&y++,d(e)});const v=o[o.length-1];y>0&&!p(v)?g(v):d(v)}static checkNode(t,s){let n=!0;const o=t.approve;this.isConditionNode(t)&&!t.isDefault&&!t.initiator&&w(t.conditions)&&(n=!1);const p=["myself","optional","director","supervisor","form","title"];if(this.isApproverNode(t)){if(!p.includes(o.assigneeType)&&w(o.participants))return{valid:!1,msg:"参与人不能为空"};n=!1}return n}static checkAllNode(t){let s=!0;const n=(o,p,d)=>{!this.checkNode(o,d)&&p(),o.children&&n(o.children,p,d),w(o.conditionNodes)||o.conditionNodes.forEach(g=>n(g,p,o))};return n(t,()=>s=!1),s}}const A=E=>(Ne("data-v-31926242"),E=E(),_e(),E),be={class:"editMainContainer"},Se={style:{position:"absolute",top:"41px",right:"0px","z-index":"20","font-size":"12px !important",width:"640px","background-color":"white"}},we={key:0,class:"editLegendHeader"},Ae=["src"],Le=W(" 缩略图 "),De={class:"legendItem"},Pe=A(()=>N("div",{style:{"font-size":"22px"}},"🦉🦉🦉🦉🦉🦉🦉🦉",-1)),Oe=A(()=>N("div",null,"点击图形中节点/元素后",-1)),Te=A(()=>N("div",null,"如果当前设置为审批面板，则弹出审批设置面板",-1)),Me=A(()=>N("div",null,"如果当前设置为格式面板，则显示图形格式调整面板",-1)),Re=A(()=>N("div",null,"格式面板主要用于调整图形外观尺寸，颜色等，与流程设置无关。",-1)),Ve=A(()=>N("div",null,"如果需要调整样式建议使用工作流组件和网关栏下的图形组件,其他栏组件均为可替换图片。",-1)),Ue={class:"dialog-footer"},ke=W("知道了"),Ge=ae({__name:"index",props:{conf:{type:Object,default:E=>{}},fields:{type:Array,default:[]},conditions:{type:Array,default:[]},enableEditing:{type:Boolean,default:!0}},setup(E,{expose:t}){const s=E,n=V(()=>R(()=>import("./index.873c33fc.js"),["assets/index.873c33fc.js","assets/_plugin-vue_export-helper.c27b6911.js","assets/vue.72f2672d.js"])),o=V(()=>R(()=>import("./index.eda77962.js"),["assets/index.eda77962.js","assets/_plugin-vue_export-helper.c27b6911.js","assets/vue.72f2672d.js"])),p=V(()=>R(()=>import("./index.f528842c.js"),["assets/index.f528842c.js","assets/Permission.7427cd78.js","assets/vue.72f2672d.js","assets/_plugin-vue_export-helper.c27b6911.js","assets/Permission.8385cb28.css","assets/Operation.87dde98a.js","assets/Participant.0e8904be.js","assets/index.972b8136.js","assets/user-select.3de4c006.js","assets/User.7b8f477f.js","assets/http-client.193f2c5b.js","assets/index.57385bce.js","assets/index.0c380c40.js","assets/index.41e0794f.js","assets/storage.6b2e7cd0.js","assets/org-menu.vue_vue_type_script_setup_true_lang.44f66112.js","assets/Org.a1ce8cb9.js","assets/tree.d5b28a07.js","assets/index.79e12c01.js","assets/index.1e09e151.js","assets/index.eead254e.js","assets/_Uint8Array.e4cf923d.js","assets/index.55c7ed79.js","assets/_initCloneObject.7b8933bc.js","assets/focus-trap.c8a23a9c.js","assets/user-select.9baf66be.css","assets/org-select.vue_vue_type_script_setup_true_lang.940de93a.js","assets/role-select.vue_vue_type_script_setup_true_lang.2c88811a.js","assets/Role.ffc550a0.js","assets/index.c0eb9a2b.css","assets/Participant.50caa650.css","assets/Condition.c612eac6.js","assets/Condition.128bdc69.css","assets/Circulate.cc347be4.js"])),d=V(()=>R(()=>import("./index.6bed4581.js"),["assets/index.6bed4581.js","assets/_plugin-vue_export-helper.c27b6911.js","assets/vue.72f2672d.js","assets/index.73fd2e39.css"])),{proxy:g}=ye(),y=Y(),v=Y(),e=ce({isShowApproval:!0,enableEditing:!0,isErrorShow:!1,validResults:[],startActivityId:0,nodes:{},lines:[],curNode:{},curCellType:"",isPropPanel:!0,graph:null,saveCurrentTopo:!1,cellProperty:!1,importFile:!1,cellData:{},curCellId:{}});Ee("titleChange",i=>{var l=e.graph.getSelectionCells();e.graph.cellLabelChanged(l[0],i)});const q=()=>{e.graph.addListener(mxEvent.CELLS_ADDED,(l,a)=>{const c=a.properties.cells[0];e.graph.isPart(c)||(c.vertex?z(c):c.edge&&(z(c,"condition"),T.addLine(e.lines,{id:c.id,fromId:c.source.id,toId:c.target.id})))});var i=e.graph.cellLabelChanged;e.graph.cellLabelChanged=function(l,a,c){e.nodes[l.id].title!==a&&(e.nodes[l.id].title=a),i.apply(this,arguments)},e.graph.addListener(mxEvent.CONNECT_CELL,(l,a)=>{let c=a.properties.edge;a.properties.previous.id!==a.properties.terminal.id&&T.changeLine(e.lines,c.id,{id:c.id,fromId:c.source.id,toId:c.target.id},e.nodes)}),e.graph.addListener(mxEvent.CELLS_REMOVED,(l,a)=>{J(()=>{a.properties.cells.forEach(h=>{h.vertex?h.isGroup||ee(T.removeNode(e.nodes,h.id,e.lines)):h.edge&&T.removeLine(e.lines,h.id,e.nodes)})})})},Q=()=>{let i=0,l=0,a=[],c={},h={};const r=(u,f)=>{a.push({msg:u,group:f})};e.lines.forEach(u=>{c.hasOwnProperty(u.fromId)||(c[u.fromId]=[]),h.hasOwnProperty(u.toId)||(h[u.toId]=[]),c[u.fromId].push(u),h[u.toId].push(u)});for(let u in e.nodes){let f=e.nodes[u];f.type!=="condition"&&(f.type==="start"&&(e.startActivityId=f.id),f.type==="start"?i++:f.type==="end"&&l++,!["copy","end","inclusiveGw","exclusiveGw","parallelGw"].includes(f.type)&&f.permission&&f.permission.length===0&&r("请配置节点表单数据权限",f.title),["approve","deal"].includes(f.type)&&f.approve.hasOwnProperty("participants")&&(["myself","optional","director","supervisor","form","title"].includes(f.approve.assigneeType)||f.approve.participants.user.length===0&&f.approve.participants.role.length===0&&f.approve.participants.org.length===0&&r("请配置节点审批人员",f.title)),["start"].includes(f.type)||(!h[f.id]||h[f.id].length===0)&&r("节点需要入向连接",f.title),f.type==="end"?c[f.id]&&c[f.id].length>0&&r("结束节点应只存在入向连接",f.title):(!c[f.id]||c[f.id].length===0)&&r("节点需要出向连接",f.title))}(i==0||i>1)&&r("流程必须包含开始节点且唯一"),(l==0||l>1)&&r("流程必须包含结束节点且唯一");let m={};if(e.startActivityId>0){let u=!1;const f=(C,I)=>{var b=e.nodes[C],M=JSON.parse(JSON.stringify(b));if(I&&(M=e.nodes[I]),!(m[C]&&I)){if(m[C]=!0,b.type==="parallelGw"||(M==null?void 0:M.type)==="parallelGw"){u=!0;return}else if(c[C]){let B=c[C],X=[];B.forEach(L=>{var _=e.nodes[L.id],S=-1;if(_.condition?_.condition.isDefault?(S=0,X.push(L)):!_.condition.filters||_.condition.filters.length===0?S=-1:S=1:S=-1,B.length>1?S===-1&&(_.title===""&&(_.title="条件_"+_.id,$(_.id,_.title)),r("节点存在多条出向连线，请点击连线["+_.title+"]配置条件",b.title)):S===1&&r("节点仅一条出向连线，请点击连线["+_.title+"]取消条件配置",b.title),e.nodes[L.toId].type!=="end")f(L.toId,L.id);else{u=!0;return}}),B.length>1&&(X.length===0?r("节点未设置默认条件，存在无法到达后续节点风险",b.title):X.length>1&&r("节点默认条件只允许1个",b.title))}}};f(e.startActivityId),u||r("流程路线不完整")}return e.validResults=a,e.validResults.length>0&&(e.isErrorShow=!0),a},Z=()=>new Promise((i,l)=>{Q().length===0?i({nodes:e.nodes,lines:e.lines,startActivityId:e.startActivityId,chartData:H()}):l({msg:"流程校验错误",target:"flowDesign"})}),j=()=>{var i;e.curNode!==void 0?(i=v.value)==null||i.open():g.$modal.msgWarning("请先选中单个节点再点编辑")},ee=i=>{var l=[];i.forEach(a=>{var c=K(a);c&&l.push(c)}),e.graph.removeCells(l)},z=(i,l)=>{if(i!==void 0){var a=i.id,c=e.graph.getCellStyle(i),h=l||mxUtils.getValue(c,"type","");if(h===""&&(h=""),h!==""){e.curCellType=h;let r={title:h+"_"+a,id:a,type:h,approve:{},condition:{},permission:[]};r.type==="start"?r.title="开始":r.type==="end"?r.title="结束":r.type==="deal"?r.title="人工_"+r.id:r.type==="approve"?r.title="审批_"+r.id:r.type==="parallelGw"?r.title="并行_"+r.id:r.type==="exclusiveGw"?r.title="排他_"+r.id:r.type==="condition"&&(r.title=""),T.addNode(e.nodes,r),$(r.id,r.title),k(a)}else g.$modal.msgWarning("添加了一个非流程节点图形")}},$=(i,l)=>{const a=K(i);a!==null&&e.graph.cellLabelChanged(a,l)},k=i=>{e.nodes[i]&&(e.curNode=e.nodes[i],e.isShowApproval&&j())},te=(i,l)=>{e.curNode=e.nodes[i]},oe=()=>{e.editorUiInit.actions.get("outline").funct(),e.editorUiInit.refresh()},ie=(i,l)=>{const a=document.createElement("a");a.setAttribute("href","data:application/xml;charset=utf-8,"+encodeURIComponent(l)),a.setAttribute("download",i),a.style.display="none",document.body.appendChild(a),a.click(),document.body.removeChild(a)},H=()=>{const i=e.editorUiInit.editor.getGraphXml();return new XMLSerializer().serializeToString(i)},se=({name:i="topology"}={})=>{ie(`${i}.xml`,H()),e.saveCurrentTopo=!1},ne=i=>{const{cell:l}=e.cellData;var a=mxUtils.createXmlDocument(),c=a.createElement("object");Object.keys(i).forEach(h=>{c.setAttribute(h,i[h])}),e.editorUiInit.editor.graph.getModel().setValue(l,c),e.cellProperty=!1,e.cellData={}},re=i=>{e.graph.diagramXml=i,e.graph.getModel().beginUpdate();try{const a=mxUtils.parseXml(i).documentElement,c=new mxCodec(a.ownerDocument);e.graph.getModel().clear(),c.decode(a,e.graph.getModel())}catch(l){console.log("err",l)}finally{e.graph.getModel().endUpdate()}le()},le=()=>{Object.values(e.graph.getModel().cells).forEach(i=>{i.vertex&&i.data&&(i.data=JSON.parse(i.data))})},K=i=>{var l=e.graph.getModel(),a=l.getCell(i);return a},G=i=>{e.graph&&i&&i.length>10&&re(i)},de=i=>{i.ctrlKey&&(i.keyCode===83&&(e.saveCurrentTopo=!0,i.preventDefault()),i.keyCode==77&&i.preventDefault())};return pe(()=>{{const i=EditorUi.prototype.init;EditorUi.prototype.getCellsForShapePicker=function(a){var c=mxUtils.bind(this,function(h,r,m,u){return this.editor.graph.createVertex(null,null,u||"",0,0,r||120,m||60,h,!1)});return[c("shape=bpmShape;type=parallelGw;verticalLabelPosition=bottom;strokeColor=#0082cf;fillColor=#a6cce5",50,50),c("shape=bpmShape;type=exclusiveGw;verticalLabelPosition=bottom;strokeColor=#0082cf;fillColor=#a6cce5",50,50)]},EditorUi.prototype.init=function(){i.apply(this,arguments),this.actions.get("export").setEnabled(!1),this.actions.addAction("editData",function(){j()},null,null,"Cmd+M")},mxResources.loadDefaultBundle=!1;const l=mxResources.getDefaultBundle(RESOURCE_BASE,mxLanguage)||mxResources.getSpecialBundle(RESOURCE_BASE,mxLanguage);mxUtils.getAll([l,"/resources/default.xml"],a=>{mxResources.parse(a[0].getText());const c={};c[Graph.prototype.defaultThemeName]=a[1].getDocumentElement(),e.editorUiInit=new EditorUi(new Editor(urlParams.chrome=="0",c),y.value),e.graph=e.editorUiInit.editor.graph,mxEdgeHandler.prototype.isConnectableCell=()=>!1,mxGraphHandler.prototype.guidesEnabled=!0,e.graph.setDisconnectOnMove(!1),e.graph.setAllowDanglingEdges(!1),mxGraph.prototype.isCellMovable=h=>!h.edge,e.graph.setMultigraph(!1),e.graph.setAllowLoops(!1),mxGraph.prototype.edgeLabelsMovable=!1,q(),e.graph.addMouseListener({currentState:null,previousStyle:null,mouseDown:(h,r)=>{if(r.state){if(r.state.cell.edge){k(r.state.cell.id);return}}else{e.curNode=void 0;return}const m=r.state.cell;let u=!1;if(k(m.id),m.style!==void 0&&(u=m.style.includes("normalType")),u)e.graph.fireEvent(new MxEventObject(MxEvent.NORMAL_TYPE_CLICKED,"cell",r));else return},mouseMove:(h,r)=>{e.graphX=Math.ceil(r.graphX),e.graphY=r.graphY},mouseUp:(h,r)=>{if(e.cellData={},r.sourceState!=null){var m=r.sourceState.cell;if(m){m.vertex?e.isNode=!0:e.isNode=!1;var u=m.getStyle()?m.getStyle():null;if(e.isNode||u&&(e.edgeStyle=u),u){var f=u.split(";"),C={};f.forEach(I=>{C[I.split("=")[0]]=I.split("=")[1]}),e.cellStyle=C,te(m.id,e.cellStyle)}}else g.$modal.msgError("请选择节点或者连线")}}}),J(()=>{document.getElementsByClassName("geDiagramContainer")[0].style="inset: 41px 240px 0px 220px; touch-action: none; cursor: default; overflow: hidden;",document.getElementsByClassName("geSidebarContainer")[0].style="left: 0px; top: 41px; width: 220px; bottom: 0px;",G(s.conf.chartData)})},a=>{g.$modal.msgError("当前浏览器不支持")})}}),ue(()=>s.conf,i=>{typeof i=="object"&&i.chartData!==void 0&&(e.lines=i.lines,e.nodes=i.nodes,G(i.chartData))},{immediate:!0}),t({getSetting:Z,getNodes:()=>e.nodes}),(i,l)=>{const a=D("el-switch"),c=D("el-tooltip"),h=D("el-alert"),r=D("el-button"),m=D("el-dialog");return U(),F("div",be,[fe(N("div",Se,[x(P(p),{ref_key:"propPanelRef",ref:v,node:e.curNode,fields:s.fields,conditions:s.conditions},null,8,["node","fields","conditions"])],512),[[he,e.isPropPanel]]),s.enableEditing?(U(),F("div",we,[N("div",{onClick:oe,class:"legendItem"},[N("img",{src:P(Ie),width:"10",alt:""},null,8,Ae),Le]),N("div",De,[x(c,{effect:"light"},{content:O(()=>[Pe,Oe,Te,Me,Re,Ve]),default:O(()=>[x(a,{modelValue:e.isShowApproval,"onUpdate:modelValue":l[0]||(l[0]=u=>e.isShowApproval=u),"inline-prompt":"","inactive-color":"rgb(0, 130, 207)","active-text":"审批面板","inactive-text":"格式面板"},null,8,["modelValue"])]),_:1})])])):ge("",!0),N("div",{class:"graphEditorContainer",ref_key:"editorContainerRef",ref:y,onKeydown:de},null,544),x(P(o),{isVisible:e.cellProperty,detailData:e.cellData,onOnDialogClose:l[1]||(l[1]=()=>{e.cellProperty=!1,e.cellData={}}),onOnDialogConfirm:ne},null,8,["isVisible","detailData"]),x(m,{modelValue:e.isErrorShow,"onUpdate:modelValue":l[3]||(l[3]=u=>e.isErrorShow=u),title:"流程设计器验证"},{footer:O(()=>[N("span",Ue,[x(r,{onClick:l[2]||(l[2]=u=>e.isErrorShow=!1)},{default:O(()=>[ke]),_:1})])]),default:O(()=>[(U(!0),F(me,null,ve(e.validResults,u=>(U(),Ce(h,{type:u.type||"error","show-icon":"",title:"【"+(u.group||"全局")+"】"+u.msg,style:{"margin-bottom":"10px"},closable:!1,"close-text":"【"+u.group+"】"},null,8,["type","title","close-text"]))),256))]),_:1},8,["modelValue"]),x(P(n),{isVisible:e.saveCurrentTopo,onOnDialogClose:l[4]||(l[4]=u=>e.saveCurrentTopo=!1),onOnDialogConfirm:se},null,8,["isVisible"]),x(P(d),{isVisible:e.importFile,onOnDialogClose:l[5]||(l[5]=u=>e.importFile=!1),onOnDialogConfirm:G},null,8,["isVisible"])])}}});const $e=xe(Ge,[["__scopeId","data-v-31926242"]]);export{$e as default};
